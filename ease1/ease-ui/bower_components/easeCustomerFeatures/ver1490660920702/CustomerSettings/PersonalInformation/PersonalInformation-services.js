define(["angular"],function(e){function t(t,r,n,o,a,s,i,l,u,c,m,f,d,p,h){function b(e){var t=e.phoneNumber.toString();this.formattedPhoneNumber="("+t.slice(0,3)+") "+t.slice(3,6)+"-"+t.slice(6),this.isPrimary="true"===e.isPrimary,this.phoneType=e.phoneType,this.hasTcpaConsent="true"===e.hasTcpaConsent,this.smsStatus=e.smsStatus,this.phoneNumber=e.phoneNumber,this.isValid="true"===e.isValid,this.accountReferenceId=e.accountReferenceId,this.businessPhoneReferenceId=e.businessPhoneReferenceId}function P(e,t){return!p.isEmpty(e.entries)&&e.entries.forEach(function(e){t[e.phoneType]=new b(e)}),e.easeDisplayError&&!p.isEmpty(e.easeDisplayError)&&!isNaN(e.easeDisplayError.severity)&&parseInt(e.easeDisplayError.severity,10)>1&&(t.easeDisplayError=e.easeDisplayError),t}function g(e,t){var r={work:{phoneType:"work",isPrimary:!1},mobile:{phoneType:"mobile",isPrimary:!1}};return/personal/i.test(e)?r.home={phoneType:"home",isPrimary:!1}:/small-business/i.test(e)&&t&&(r.work.accountReferenceId=t.referenceId,r.mobile.accountReferenceId=t.referenceId,r.accountDisplayName=t.accountNickname||t.displayName,r.accountDisplayName+=" ... "+t.accountNumberTLNPI.substring(t.accountNumberTLNPI.length-4,t.accountNumberTLNPI.length)),r}function y(e){var t={};return e.entries&&e.entries.forEach(function(e){e.entries&&e.entries.length>0&&(t[e.entries[0].accountReferenceId]=e)}),t}function E(e){var t=g("personal");return P(e,t)}function v(e){var t={phoneNumbers:[]},r=y(e);return e.easeDisplayError&&!p.isEmpty(e.easeDisplayError)&&!isNaN(e.easeDisplayError.severity)&&parseInt(e.easeDisplayError.severity,10)>1&&(t.easeDisplayError=e.easeDisplayError),S.forEach(function(e){var n=g("small-business",e),o=r[e.referenceId]||[];n=P(o,n),t.phoneNumbers.push(n)}),t}var S=[],C=function(e){for(var t=[],r=e.entries.contactPointDetail||[],n=0;n<r.length;n++)t.push({primaryIndicator:r[n].primaryIndicator,contactPointStatus:r[n].contactPointStatus,emailAddress:r[n].emailContactPoint.emailAddress,contactPointId:r[n].contactPointId,id:"emailAddress"+n});return t};return{getSmallBusinessAccounts:function(){return S},setSmallBusinessAccounts:function(e){S=p.filter(e,function(e){return/cc/i.test(e.category)&&/business/i.test(e.accountUseType)})||[]},checkForPersonalAccounts:function(e){var t=this;t.hasPersonalAccounts=e.some(function(e){return"CC"!==e.category||"Business"!==e.accountUseType})},hasPersonalAccounts:!0,errorContentData:{},primaryEmailObj:"",primaryEmailInvalid:!1,isVerifyState:function(e){return e===t.states.kVerify},isProfileState:function(){return h.current.name===t.states.kProfile},setErrorContentData:function(e){this.errorContentData=e},isPrimary:function(e){return e&&e.primaryIndicator===!0?e:void 0},isPrimaryEmailInvalid:function(){return this.primaryEmailInvalid},setPrimaryEmailInvalid:function(e){this.primaryEmailInvalid=e},findPrimaryEmail:function(e){var t=e?e.filter(this.isPrimary):"";this.primaryEmailObj=t?t[0]:"",this.primaryEmailObj&&this.primaryEmailObj.contactPointStatus&&("Failed"===this.primaryEmailObj.contactPointStatus?this.setPrimaryEmailInvalid(!0):this.setPrimaryEmailInvalid(!1))},getPrimaryEmail:function(){return this.primaryEmailObj},openFeatureUnavailable:function(){m.$broadcast("error",{msgHeader:this.errorContentData&&this.errorContentData.common_snag_en_US?this.errorContentData.common_snag_en_US[f.kSnagModalHeader]:"",msgBody:this.errorContentData&&this.errorContentData.common_snag_en_US?this.errorContentData.common_snag_en_US[f.kSnagFeatureOffLabel]:""})},updatePubSub:function(e){e?i.pubsubTrackAnalytics(e):i.pubsubTrackAnalytics({taxonomy:{level1:"ease",level2:"customer profile preferences",level3:"profile",level4:"",level5:"",country:"us",language:"english",system:"ease_web"},lob:l.getLobArray().join(" | ")})},updatePhoneNumber:function(e){this.openEditPhoneNumberModal(e)},openAddEmailModal:function(){i.pubsubTrackAnalytics({taxonomy:{level1:"ease",level2:"customer profile preferences",level3:"profile",level4:"add email",level5:"",country:"us",language:"english",system:"ease_web"},lob:l.getLobArray().join(" | ")}),u.showModal({templateUrl:c.get("PersonalInformation","","addEmail"),controller:"PersonalInfoAddEmailModalCtrl",inputs:{email:null,pubSubOnClose:null}}).then(function(e){e.close.then(function(){m.$emit("returningToProfilePage")})})},openEditEmailModal:function(e,t,r){var n=this,o={taxonomy:{level1:"ease",level2:"customer profile preferences",level3:"profile",level4:"edit email",level5:"",country:"us",language:"english",system:"ease_web"},lob:l.getLobArray().join(" | ")};t=t||o,n.updatePubSub(t),u.showModal({templateUrl:c.get("PersonalInformation","","editEmail"),controller:"PersonalInfoAddEmailModalCtrl",inputs:{email:e,pubSubOnClose:r}}).then(function(e){e.close.then(function(){})})},buildPhoneModalObj:function(e){var t={taxonomy:{level1:"ease",level2:"customer profile preferences",level3:"profile",level4:"edit "+e.phoneType+" number",level5:"",country:"us",language:"english",system:"ease_web"},lob:l.getLobArray().join(" | ")};return{number:e,error:null,originalNumberPreferences:null,pubsubObj:t,pubSubOnClose:!1}},openEditPhoneNumberModal:function(e){var t=this;t.updatePubSub(e.pubsubObj),u.showModal({templateUrl:c.get("PersonalInformation","","editPhoneNumber"),controller:"PersonalInfoEditPhoneNumberModalCtrl",inputs:{number:e.number,openEditTcpaSettingsModal:this.openEditTcpaSettingsModal,error:e.error,originalNumberPreferences:e.originalNumberPreferences,pubSubOnClose:e.pubSubOnClose,modalTitle:e.modalTitle}}).then(function(e){e.close.then(function(){m.$emit("returningToProfilePage")})})},openEditTcpaSettingsModal:function(e,t,r,n){var o=this;o.updatePubSub(r),u.showModal({templateUrl:c.get("PersonalInformation","","editTcpaConsent"),controller:"PersonalInfoEditTcpaModalCtrl",inputs:{number:e,openEditPhoneNumberModal:this.openEditPhoneNumberModal,openConfirmTcpaExitModal:this.openConfirmTcpaExitModal,originalNumberPreferences:t,pubSubOnClose:n}}).then(function(e){e.close.then(function(){m.$emit("returningToProfilePage")})})},openEditSmsModal:function(e,t,r,n,o,a){var s=this;s.updatePubSub(t),u.showModal({templateUrl:c.get("PersonalInformation","","editSmsAlert"),controller:"PersonalInfoEditSmsCtrl",inputs:{mobileData:e,isSmsEnabled:r,fromProfile:n,originalNumberPreferences:o,fromTcpaFlow:a}}).then(function(e){e.close.then(function(){m.$emit("returningToProfilePage")})})},showSuccessSmsModal:function(e,t){var r=this;r.updatePubSub(e),u.showModal({templateUrl:c.get("PersonalInformation","","successSmsModal"),controller:"PersonalInfoSuccessSmsCtrl",inputs:{mobileData:t}}).then(function(e){e.close.then(function(){r.updatePubSub(),m.$emit("returningToProfilePage")})})},openDisableSmsConfirmationModal:function(e,t){var r=this;r.updatePubSub(t),u.showModal({templateUrl:c.get("PersonalInformation","","confirmationModal"),controller:"PersonalInfoConfirmModalCtrl",inputs:{content:{title:r.getProfileprefContentData()["ease.core.profileprefs.phone.sms.disablemodal.title"],alertText:r.getProfileprefContentData()["ease.core.profileprefs.phone.sms.disablemodal.warning.firstpart"],boldText:e.formattedPhoneNumber||e.phoneNumber,closingText:r.getProfileprefContentData()["ease.core.profileprefs.phone.sms.disablemodal.warning.secondpart"],buttonLabel:r.getProfileprefContentData()["ease.core.profileprefs.phone.sms.disablemodal.buttontext"],linkText:r.getProfileprefContentData()["ease.core.profileprefs.phone.sms.disablemodal.linktext"]},callBacks:{buttonFn:function(){r.updatePhoneNumberSettings(e,"DIRECT_DISABLE",function(){var t={phoneNumber:e.phoneNumber};e.accountReferenceId?m.$emit("updateSmallBusinessPhoneNumbers",{phoneObj:t}):m.$emit("updatePhoneNumbers",{phoneObj:t}),r.updatePubSub()})}},pubSubOnClose:{taxonomy:{level1:"ease",level2:"customer profile preferences",level3:"profile",level4:"",level5:"",country:"us",language:"english",system:"ease_web"}}}}).then(function(e){e.close.then(function(){m.$emit("returningToProfilePage")})})},updatePhoneNumberSettings:function(t,r,n){var o=e.copy(t),a=this;return r&&(o.smsStatus=r),o.phoneNumber=o.phoneNumber.replace(/[^\/\d]/g,""),a.editPhoneNumber(o).then(n)},openConfirmTcpaExitModal:function(e,t,r,n){this.updatePubSub(r),u.showModal({templateUrl:c.get("PersonalInformation","","confirmTcpaExit"),controller:"PersonalInfoConfirmTcpaExitModalCtrl",inputs:{number:e,openEditTcpaSettingsModal:this.openEditTcpaSettingsModal,originalNumberPreferences:t,pubSubOnClose:n}}).then(function(e){e.close.then(function(){m.$emit("returningToProfilePage")})})},editEmailModal:function(e,t,r){this.openEditEmailModal(e,t,r)},openSmsErrorModal:function(e,t){var r=this,n={taxonomy:{level1:"ease",level2:"customer profile preferences",level3:"profile",level4:"sms",level5:"enrolled",country:"us",language:"english",system:"ease_web"},lob:l.getLobArray().join(" | ")};r.updatePubSub(n),u.showModal({templateUrl:c.get("PersonalInformation","","smsAlreadyEnrolled"),controller:"PersonalInfoSmsErrorCtrl",inputs:{mobileData:e,content:t}}).then(function(e){e.close.then(function(){})})},getNumberLabel:function(e){var t=this.getProfileprefContentData();return t["ease.core.profileprefs.phone."+e+".input.label"]},contentDataProfilepref:{},profilePictireData:{},setProfileprefContentData:function(e){this.contentDataProfilepref=e},getProfileprefContentData:function(){return this.contentDataProfilepref.core_profileprefs_en_US},getSmsAlertArticleContentData:function(){return this.contentDataProfilepref.core_sms_message_en_us},setProfilePictureData:function(e,t){this.profilePictireData={newImageData:e,currentImageData:t}},getProfilePictureData:function(){return this.profilePictireData},getEmailList:function(){var e=this,i=n.defer(),l=t.kGetEmailUrl;return r.setBaseUrl(a.baseUrl()),o.clearCustomerActivityHeader(),o.setCustomerActivityHeader("50076"),r.all(l).customGET().then(function(e){e.entries?i.resolve(C(e)):i.resolve(null)},function(t){throw i.resolve(),s.displayErrorHadler(e.errorContentData[f.kCommonSnag+"en_US"][f.kSnagModalHeader],e.errorContentData[f.kCommonSnag+"en_US"]["core.common.snag.modal.needtofix.label"]),s.createEaseException({module:"PersonalInformationDisplayEmail",message:t.statusText,cause:t})}),i.promise},getPhoneNumberList:function(e){var i=this,l=n.defer(),u=t.kGetPhoneNumbersUrl;return r.setBaseUrl(a.baseUrl()),o.clearCustomerActivityHeader(),o.setCustomerActivityHeader(e),r.all(u).customGET().then(function(e){i.parsedPersonalPhoneNumbers=E(e),l.resolve(i.parsedPersonalPhoneNumbers)},function(e){throw l.resolve(),s.displayErrorHadler(i.errorContentData[f.kCommonSnag+"en_US"][f.kSnagModalHeader],i.errorContentData[f.kCommonSnag+"en_US"]["core.common.snag.modal.needtofix.label"]),s.createEaseException({module:"PersonalInformationDisplayPhoneNumbers",message:e.statusText,cause:e})}),l.promise},getParsedPersonalPhoneNumbers:function(){var e=this;return e.parsedPersonalPhoneNumbers},getSmallBusinessPhoneNumberList:function(e){var i=this,l=n.defer(),u=t.kGetSmallBusinessPhoneNumbersUrl;return r.setBaseUrl(a.baseUrl()),o.clearCustomerActivityHeader(),o.setCustomerActivityHeader(e),r.all(u).customGET().then(function(e){l.resolve(v(e))},function(e){throw l.resolve(),s.displayErrorHadler(i.errorContentData[f.kCommonSnag+"en_US"][f.kSnagModalHeader],i.errorContentData[f.kCommonSnag+"en_US"]["core.common.snag.modal.needtofix.label"]),s.createEaseException({module:"PersonalInformationDisplaySmallBusinessPhoneNumbers",message:e.statusText,cause:e})}),l.promise},isSmsEnabled:function(e){return e.smsStatus?p.includes(["REQ_ENABLE","VERIFIED_ENABLE","VERIFICATION_IN_PROGRESS"],e.smsStatus):void 0},postGreetingName:function(e){var a=r.all(t.kProfilePreferences),s={greetingName:e},i=n.defer();return o.clearCustomerActivityHeader(),o.setCustomerActivityHeader("50069"),a.post(s).then(function(t){o.setGreetingName(e),i.resolve(t)},function(e){d.info("Greeting Name Error with status code",e.status),i.reject()}),i.promise},postProfilePicture:function(e){var a=n.defer();r.setBaseUrl(t.baseUrl);var s=r.all(t.kProfilePreferences);o.setCustomerActivityHeader("50023");var i=e.profilePictureData;return""!==i&&s.post(e).then(function(e){e.easeDisplayError&&!e.easeDisplayError.severity&&e.isDisplayData&&o.setProfileImage(i),a.resolve(e)},function(){a.reject()}),a.promise},postAddEmail:function(e){var a=r.all(t.kProfileAddEmail),s={primaryIndicator:e.isPrimary,emailContactPoint:{emailAddress:e.email?e.email.toLowerCase():"",emailMessageFormat:"HTML"}},i=n.defer();return o.clearCustomerActivityHeader(),o.setCustomerActivityHeader("50077"),a.post(s).then(function(e){i.resolve(e)},function(e){d.info("Add Email Error with status code",e.status),i.reject()}),i.promise},editEmail:function(e){var a={contactPointId:e.contactPointId,primaryIndicator:e.isPrimary,emailContactPoint:{emailAddress:e.email?e.email.toLowerCase():"",emailMessageFormat:"HTML"}},i=n.defer();o.clearCustomerActivityHeader(),o.setCustomerActivityHeader("50078");var l=t.kGetEmailUrl;return r.all(l).customPUT(a).then(function(e){i.resolve(e)},function(e){throw i.reject(),s.createEaseException({module:"PersonalInformationEditEmail",message:e.statusText,cause:e})}),i.promise},deleteEmail:function(e){var a={contactPointId:e.contactPointId},i=n.defer();o.clearCustomerActivityHeader(),o.setCustomerActivityHeader("50079");var l=t.kDeleteEmailUrl;return r.all(l).post(a).then(function(e){i.resolve(e)},function(e){throw i.reject(),s.createEaseException({module:"PersonalInformationDeleteEmail",message:e.statusText,cause:e})}),i.promise},editPhoneNumber:function(e){var a,s=n.defer(),i=e.isNewNumber;if(delete e.isNewNumber,o.clearCustomerActivityHeader(),o.setCustomerActivityHeader("50088"),e.accountReferenceId){delete e.isPost;var l;l=i?t.kPutSmallBusinessPhoneNumbersUrl:t.kPostSmallBusinessPhoneNumbersUrl,a=r.all(l),a.customPOST(e).then(function(e){s.resolve(e)},function(e){d.info("Edit small business phone number Error with status code",e.status),s.reject(e)})}else a=r.all(t.kPutPhoneNumbersUrl),e.isPost?(delete e.isPost,a.customPOST(e).then(function(e){s.resolve(e)},function(e){d.info("Edit phone number Error with status code",e.status),s.reject(e)})):a.customPUT(e).then(function(e){s.resolve(e)},function(e){d.info("Edit phone number Error with status code",e.status),s.reject(e)});return s.promise},closeModal:function(e,t){e="",t.$modalCancel()},deletePhone:function(e){var a,i,l=n.defer();return o.clearCustomerActivityHeader(),o.setCustomerActivityHeader("50087"),e.businessPhoneReferenceId?(a={businessPhoneReferenceId:e.businessPhoneReferenceId},i=t.kDeleteSmallBusinessPhoneUrl,r.all(i).customPOST(a).then(function(e){l.resolve(e)},function(e){throw l.reject(),s.createEaseException({module:"PersonalInformationDeleteSmallBusinessPhone",message:e.statusText,cause:e})})):(a={phoneType:e.phoneType},i=t.kDeletePhoneUrl+"/"+a.phoneType,r.all(i).remove().then(function(e){l.resolve(e)},function(e){throw l.reject(),s.createEaseException({module:"PersonalInformationDeletePhone",message:e.statusText,cause:e})})),l.promise},getBankAddressLabel:function(e){var t=e,r=!1,n=!1,o=!1;t.forEach(function(e){"AL"===e.category?r=!0:-1!==["MLA","HLC","HIL"].indexOf(e.category)?n=!0:"360"===e.subCategory&&(o=!0)});var a=[r,n,o];switch(a.toString()){case"false,true,false":return"ease.core.profileprefs.address.home.label";case"true,true,false":return"ease.core.profileprefs.address.homeauto.label";case"false,true,true":return"ease.core.profileprefs.address.home360.label";case"true,true,true":return"ease.core.profileprefs.address.homeauto360.label";case"true,false,false":return"ease.core.profileprefs.address.auto.label";case"true,false,true":return"ease.core.profileprefs.address.auto360.label";case"false,false,true":return"ease.core.profileprefs.address.360.label";default:return}},getCardAddressLabel:function(e){var t=e,r=!1;return t.forEach(function(e){"CC"===e.category&&(r=!0)}),r?"ease.core.profileprefs.address.card.label":void 0}}}return t.$inject=["EaseConstant","Restangular","$q","EASEUtilsFactory","EaseConstantFactory","easeExceptionsService","pubsubService","summaryService","easeUIModalService","easeCoreTemplates","$rootScope","ContentConstant","$log","_","$state"],e.module("personalInformationModule").factory("profileInfoFactory",t)});