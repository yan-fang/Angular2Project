define(["angular"],function(e){"use strict";var t=e.module("TransferModule");return t.controller("TransferEditCtrl",["easeUIModalService","transferState","$state","TransferFactory","TransferAnalytics","easeTemplates",function(e,t,a,n,r,s){e.showModal({templateUrl:s.get("Transfer","","edit"),controller:"TransferEditModalCtrl"}).then(function(e){e.close.then(function(e){if(!e){n.removePrintClass();var s=t.getCurrentLOB(),o={level2:n.getPageType(s)};r.trackAnalytics("",o),a.go(s)}})})}]),t.controller("TransferEditModalCtrl",["$scope","$state","$filter","transferState","TransferFactory","TransferAnalytics","EaseConstant","EASEUtilsFactory","featureToggleFactory","close","$q","CalendarService","languagePreferencesFactory","LabelEnums",function(t,a,n,r,s,o,i,c,l,u,f,d,D,T){var m,y=t;y.pending=0,y.contentData=s.getContentData();var g=r.get();y.datePickerImage=i.datePickerImg,y.editTransferData=s.getEditTransferData(),y.localeVal=D.currentLocale,y.i18nData={today_label:d.getLabel(y.localeVal,T.en.TODAY,T.es.TODAY)},y.showCancelLink=l.getFeatureToggleData()?l.getFeatureToggleData()[i.features.transferScheduledCancelFeatureName]:!1,s.setPrintClass(),e.extend(y,{closeModal:function(e){0===y.pending&&y.close(e)},close:u,selectedView:i.kTransferViewSelection.kOneTimeTransferView,date:"",todayDate:"",arriveOnDate:"",minDate:"",amount:{payAmount:y.editTransferData.transactionAmount,isExternalTransfer:!y.editTransferData.isInternalIndicator,isInputInValid:!1,isAmountEmpty:!0,errorMessage:!1},submitted:{isSubmitted:!1},upperBound:i.kTransferAmountUpperBound,lowerBound:i.kTransferAmountLowerBound,loadingClass:!1,isLoading:!1,transferToType:"",dailyLimitRemainingAmount:null,monthlyLimitRemainingAmount:null,showArriveOnDate:!y.editTransferData.isInternalIndicator,showRemainingLimit:!1,transferSubmitted:!1,isTransferType:"one-time",options:{},backButtonOptions:{},calendarBackButton:function(){y.date=n("date")(new Date(m),"MMM dd, yyyy"),y.currentDate=y.localeDate=new Date(m),y.selectedView=i.kTransferViewSelection.kOneTimeTransferView,y.backButtonOptions.showBackButton=!1,y.showArriveOnDate&&y.setArriveOnDate()},initialize:function(){y.toggleTransferMessage="one-time"===y.isTransferType?y.contentData["ease.core.transfer.edit.tos.label"]:"",y.backButtonOptions={showBackButton:!1,backButtonClick:y.calendarBackButton}},isTransferEnabled:function(){return y.amount.payAmount<.01||y.transferSubmitted||y.isLoading||y.loadingClass||y.amount.isInputInvalid},today:function(e){function t(){return r=s.getEditTransferData().oneTimeTransferDate,y.serverTime=e,y.localeDate=new Date(r),y.currentDate=new Date(r),y.date=n("date")(new Date(r),"MMM dd, yyyy"),y.todayDate=new Date(e),a=new Date(y.date).setHours(0,0,0,0)===new Date(e).setHours(0,0,0,0),f.when(a)}var a,r,i=t;i().then(function(e){y.instantTransfer=e}),y.showArriveOnDate&&y.setArriveOnDate();var c=o.buildLOB(y.editTransferData.fromAccount.accountType,y.editTransferData.toAccount.accountType),l={level2:"edit transfer"};o.trackAnalytics(c,l),y.showRemainingLimit="retail"===y.editTransferData.fromAccount.accountType&&"external"===y.editTransferData.toAccount.accountType},showWeeks:"false",clear:function(){y.date=null},toggleDates:function(){var t,a;d.getDates().then(function(n){if(!e.isObject(n))throw"$calendarService doesn't return object";t=n.serverTime,a=t.setDate(t.getDate()+1),y.options.min_date=y.isExternalTransfer?t instanceof Date?t:new Date(t):new Date(a),y.options.max_date=n.maxDate,y.options.isDateDisabled=y.dateDisabled,y.options.customClass=y.getDayClass,y.today(t)})["catch"](function(e){throw e})},getDayClass:function(e){var t=e.date,a=new Date(y.arriveDate).setHours(0,0,0,0),n=new Date(t).setHours(0,0,0,0);new Date(y.currentDate).setHours(0,0,0,0);return e.selected?{cssClass:"",subLabel:y.getCalendarLabel(T.en.SEND,T.es.SEND)}:n===a?{cssClass:"transfer-arrive-on",subLabel:y.getCalendarLabel(T.en.ARRIVE,T.es.ARRIVE)}:{cssClass:"",subLabel:""}},dateDisabled:function(e){return y.isDisabledDates=!1,"external"===y.editTransferData.fromAccount.accountType||"external"===y.editTransferData.toAccount.accountType?(y.isDisabledDates=c.validateBankDayOffs(new Date(e)),y.isDisabledDates):y.isDisabledDates},openByKeypress:function(e){var t=e.which?e.which:e.keyCode;(32===t||13===t)&&y.open(e)},getCalendarLabel:function(e,t){var a=d.getLabel(y.localeVal,e,t);return a},open:function(e){if(o.trackAnalyticsByName("calendar:button"),!y.transferSubmitted){var a=l.getFeatureToggleData();if(a&&!a[i.features.transferScheduledFeature])t.$broadcast("Show_Schedule_Transfer_Unavailable");else{m=y.localeDate;var n={level2:"edit transfer",level3:"calendar"};o.trackAnalytics("",n),y.selectedView=i.kTransferViewSelection.kDatePickerView,y.backButtonOptions.showBackButton=!0,e.stopPropagation()}}},selectDate:function(e){var t=n("date")(new Date(e),"MMM dd, yyyy");y.localeDate=e,y.currentDate=e,y.date=t,y.instantTransfer=new Date(e).setHours(0,0,0,0)===new Date(y.serverTime).setHours(0,0,0,0),y.showArriveOnDate&&y.setArriveOnDate()},setArriveOnDate:function(){var e=i.transferArriveOnDateLogic,t=0,a=new Date(y.todayDate).setHours(0,0,0,0),r=new Date(y.localeDate).setHours(0,0,0,0);if(a===r){var o=new Date(s.getServerTime()).getHours(),l=e[y.editTransferData.fromAccount.accountType][y.editTransferData.toAccount.accountType];t=o<l.cutOffHour?l.before:l.after}else t=e[y.editTransferData.fromAccount.accountType][y.editTransferData.toAccount.accountType].before;for(var u=new Date(y.localeDate);t;)u.setDate(u.getDate()+1),c.validateBankDayOffs(u)||t--;y.arriveDate=new Date(u),y.arriveOnDate=n("date")(new Date(u),"MMM dd, yyyy")},datePickerDone:function(){var e={level2:"edit transfer"};o.trackAnalytics("",e),y.selectedView=i.kTransferViewSelection.kOneTimeTransferView,y.callback=!0,y.backButtonOptions.showBackButton=!1},setTransferSuccessData:function(e){e.accountDetails={fromAccount:y.editTransferData.fromAccount.displayName,fromAccountNumber:y.editTransferData.fromAccount.accountNumber,fromAccountType:y.editTransferData.fromAccount.accountType,toAccount:y.editTransferData.toAccount.displayName,toAccountNumber:y.editTransferData.toAccount.accountNumber,toAccountType:y.editTransferData.toAccount.accountType,payAmount:y.amount.payAmount,isExternalTransfer:y.amount.isExternalTransfer,transferDate:y.date,arriveOnDate:y.arriveOnDate}},amountStaticContent:{validationMsg:""},setApiErrorMessage:function(e){y.errorStatus="error",y.apiErrorMessage=e},updateTransfer:function(){y.errorStatus="",y.apiErrorMessage="",y.pending++,y.loadingClass=!0,y.transferSubmitted=!0;var e={moneyTransferReferenceId:s.getEditTransferData().moneyTransferReferenceId,fromAccountDetail:{moneyTransferAccountReferenceId:s.getEditTransferData().fromAccount.moneyTransferAccountReferenceId},toAccountDetail:{moneyTransferAccountReferenceId:s.getEditTransferData().toAccount.moneyTransferAccountReferenceId},transactionAmount:s.formatAmount(y.amount.payAmount).toString(),currencyCode:"USD",oneTimeTransferDate:new Date(y.localeDate).toISOString()};s.updateTransfer(e).then(function(e){y.pending--,y.loadingClass=!1,y.setTransferSuccessData(e),e.easeDisplayError?(y.setApiErrorMessage(e.easeDisplayError.displayMessage),y.handleError=e,y.amount.isInputValid=!0,y.submitted.isSubmitted=!0,y.amount.errorMessage=!0,y.transferSubmitted=!1,y.isTransferToSelected=!0):null!==e.moneyTransferID?(a.go(g.transferSuccess.name,{transfer:e}),y.closeModal(e)):y.transferSubmitted=!1})},cancelEditTransfer:function(){if(!y.transferSubmitted){y.pending++,y.isLoading=!0,y.transferSubmitted=!0;var e=f.defer(),t=a.go(g.transferCancel.name,{moneyTransferReferenceId:y.editTransferData.moneyTransferReferenceId});return o.trackAnalyticsByName("cancel transfer:link"),t.then(function(t){y.pending--,y.transferSubmitted=!1,y.isLoading=!1,e.resolve(y.closeModal(t))},function(t){y.pending--,y.transferSubmitted=!1,y.isLoading=!1,e.reject(y.closeModal(t))}),e.promise}}}),y.toggleDates(),y.initialize()}]),t});