define(["angular"],function(e){"use strict";var t=e.module("TransferModule");return t.controller("TransferIndexCtrl",["$scope","easeUIModalService","transferState","$state","TransferFactory","TransferAnalytics","easeTemplates","$stateParams","EaseConstant","EASEUtilsFactory",function(e,t,a,r,n,o,s,c,i,l){t.showModal({templateUrl:s.get("Transfer"),controller:"TransferIndexModalCtrl"}).then(function(e){e.close.then(function(e){if(n.setMemoText(""),e){var t=a.get();e.toStateName===i.stateNames.transferScheduleUnavailable?r.go(a.getCurrentLOB()+"."+i.stateNames.transferScheduleUnavailable,{data:e}):r.go(t.transferSuccess.name,{transfer:e})}else{n.removePrintClass();var o=a.getCurrentLOB(),s={level1:"ease",level2:n.getPageType(o)||"",country:"us",language:"english",system:"ease_web"};l.pubsubTrackAnalyticswithMsg(s,o),r.go(o)}})})}]),t.controller("TransferIndexModalCtrl",["$scope","EaseLocalizeService","EaseConstant","TransferFactory","TransferAnalytics","$filter","$state","EASEUtilsFactory","transferState","featureToggleFactory","$stateParams","TransferConstant","$timeout","close","CalendarService","languagePreferencesFactory","LabelEnums","dateLocalizationService",function(t,a,r,n,o,s,c,i,l,f,u,d,m,D,y,p,T,g){var w,v=t,b=/^[a-z0-9A-Z.,\- ]*$/;if(v.localeVal=p.currentLocale||r.kEnglishLocale,v.contentData=n.getContentData(),v.init=function(){y.getLocale(v.localeVal)},v.i18nData={today_label:T.en.TODAY},v.init(),v.datePickerImage=r.datePickerImg,n.setPrintClass(),a.get("accountSummary").then(function(e){v.i18n=e,v.btnCaption=v.i18n.transfer}),e.extend(v,{closeModal:function(e){v.loadingClass||v.close(e)},close:D,upperBound:r.kTransferAmountUpperBound,lowerBound:r.kTransferAmountLowerBound,loadingClass:!1,isTransferToSelected:!1,from:n.getTransferFrom(),transferFromType:"",to:n.getTransferTo(),transferToType:"",amount:{payAmount:void 0,isExternalTransfer:!1,isInputInValid:!1,isAmountEmpty:!0,errorMessage:!1},date:"",todayDate:"",arriveOnDate:"",transferData:n.getTransferData(),transferFromList:n.getTransferFromList(),transferToList:n.getTransferToList(),frequencyList:[],errorResponse:n.getErrorResponse(),item:n.getAccItem(),minDate:"",opened:!1,on:!0,isAvailBalUndefined:!1,helocMinimumAmount:null,dailyLimitRemainingAmount:null,monthlyLimitRemainingAmount:null,showArriveOnDate:!1,showRemainingLimit:!1,fromDropdown:{isOpen:!1},toDropdownOptions:{secondaryData:"",tertiaryData:"",placeholder:""},toDropdown:{selectedValue:"",referenceId:"",selectedPrimary:"",selectedSecondary:"",isOpen:!1},frequencyDropdown:{selectedValue:"",selectedPrimary:"",isOpen:!1},isEnableFrequency:!0,selectedView:r.kTransferViewSelection.kOneTimeTransferView,transferSubmitted:!1,TransferFactory:n,memo:{memoText:""},isMemoOpen:!1,isMemoError:!1,showWeeks:"false",initClose:!1,submitted:{isSubmitted:!1},options:{},isTransferType:"one-time",backButtonOptions:{},messageOptions:{iconColor:"#ff0000",isCloseIcon:!0,alertIcon:!0,globalElementId:"savingsMessage",alertContent:v.contentData["ease.core.transfer.savings.alert.message"],alertIconAria:"Alert Icon",closeIconAria:"Close Icon"},enterKeyPressed:!1,calendarBackButton:function(){v.date=s("date")(new Date(w),"MMM dd, yyyy"),v.currentDate=v.localeDate=new Date(w),v.selectedView=r.kTransferViewSelection.kOneTimeTransferView,v.backButtonOptions.showBackButton=!1,v.showArriveOnDate&&v.setArriveOnDate()},initialize:function(){v.toggleTransferMessage="one-time"===v.isTransferType?v.contentData["ease.core.transfer.index.tos.label"]:"",v.backButtonOptions={showBackButton:!1,backButtonClick:v.calendarBackButton}},keypressEvent:function(e){v.enterKeyPressed=13===e.keyCode?!0:!1},nextValidDate:function(e){for(var t=new Date(e);i.validateBankDayOffs(t);)t.setDate(t.getDate()+1);return t},clear:function(){v.date=null},toggleDates:function(){y.getDates().then(function(e){v.options.min_date=e.minDate,v.options.max_date=e.maxDate,v.options.customClass=v.getDayClass,v.options.isDateDisabled=v.dateDisabled,v.currentDate=new Date(e.minDate),v.date=s("date")(e.minDate,"MMM dd, yyyy"),v.localeDate=new Date(e.minDate),v.todayDate=new Date(e.minDate),v.serverTime=e.serverTime,v.format_day_title="MMMM dd, YYYY"})["catch"](function(e){throw e})},getDayClass:function(e){var t=e.date,a=new Date(v.arriveDate).setHours(0,0,0,0),r=new Date(t).setHours(0,0,0,0);new Date(v.currentDate).setHours(0,0,0,0);return e.selected?{cssClass:"",subLabel:v.getCalendarLabel(T.en.SEND,T.es.SEND)}:r===a?{cssClass:"transfer-arrive-on",subLabel:v.getCalendarLabel(T.en.ARRIVE,T.es.ARRIVE)}:{cssClass:"",subLabel:""}},dateDisabled:function(e){return"external"===v.transferFromType||"external"===v.transferToType?i.validateBankDayOffs(new Date(e)):!1},openByKeypress:function(e){var t=e.which?e.which:e.keyCode;(32===t||13===t)&&v.open(e)},getCalendarLabel:function(e,t){var a=y.getLabel(v.localeVal,e,t);return a},open:function(e){if(v.errorStatus="",!v.transferSubmitted){var t=f.getFeatureToggleData();if(t&&!t[r.features.transferScheduledFeature]||!v.displayCalendarIcon()){var a={toStateName:r.stateNames.transferScheduleUnavailable,referenceId:v.fromDropdown.referenceId,toReferenceId:v.toDropdown.referenceId,amount:v.amount.payAmount,date:v.date,memo:v.memo.memoText};v.closeModal(a)}else{w=v.localeDate;var n={level2:"transfer",level3:"calendar"};o.trackAnalytics("",n),e.stopPropagation(),v.selectedView=r.kTransferViewSelection.kDatePickerView,v.backButtonOptions.showBackButton=!0}}},displayCalendarIcon:function(){var e=_.find(v.transferData,function(e){return e.moneyTransferAccountReferenceId===v.fromDropdown.moneyReferenceId});if(e&&e.eligibleDebitOffsetAccounts){var t=_.find(e.eligibleDebitOffsetAccounts,function(e){return e.moneyTransferAccountReferenceId[0]===v.toDropdown.moneyReferenceId});if(t&&t.supportedPlans)return t.supportedPlans.isOneTimeScheduledSupported}return!0},isTransferInvesting:function(){return"investing"===v.fromDropdown.accountType||"investing"===v.toDropdown.accountType},amountStaticContent:{validationMsg:""},setApiErrorMessage:function(e){v.apiErrorMessage=e,v.errorStatus="error"},setMemoAttributes:function(e){var t={placeholder:v.contentData["ease.core.transfer.form.memo.ghost.label"],val:e,toggleText:v.contentData["ease.core.transfer.form.addmemo.link"],label:v.contentData["ease.core.transfer.memo.label"],limit:25,length:30};v.memoAttributes=t},memoText:"",manageMemoAttributes:function(){v.memoAttributes&&n.setMemoText(v.memoAttributes.val),v.setMemoAttributes(n.getMemoText()),v.memoAttributes&&"heloc"===v.from.accountType&&delete v.memoAttributes},selectDate:function(e){var t=s("date")(new Date(e),"MMM dd, yyyy");v.date=t,v.localeDate=e,v.currentDate=e,v.showArriveOnDate&&v.setArriveOnDate()},isInstantTransfer:function(){var e=new Date(v.localeDate).setHours(0,0,0,0),t=new Date(v.serverTime).setHours(0,0,0,0);return e===t},setArriveOnDate:function(){var e=r.transferArriveOnDateLogic,t=0,a=new Date(v.todayDate).setHours(0,0,0,0),o=new Date(v.localeDate).setHours(0,0,0,0),c=n.getServerTime()?n.getServerTime():new Date;if(a===o){var l=new Date(c).getHours(),f=e[v.transferFromType][v.transferToType];t=l<f.cutOffHour?f.before:f.after}else t=e[v.transferFromType][v.transferToType].before;for(var u=v.localeDate?new Date(v.localeDate):new Date(v.serverTime);t;)u.setDate(u.getDate()+1),i.validateBankDayOffs(u)||t--;v.arriveDate=new Date(u),v.arriveOnDate=s("date")(new Date(u),"MMM dd, yyyy")},isDisplayGlobalMessagefn:function(){v.errorResponse.globalError=!v.errorResponse.globalError},setTransferSuccessData:function(e){e.accountDetails={fromAccount:v.fromDropdown.selectedPrimary,fromAccountNumber:v.fromDropdown.selectedSecondary,fromAccountType:v.fromDropdown.accountType,toAccount:v.toDropdown.selectedPrimary,toAccountNumber:v.toDropdown.selectedSecondary,toAccountType:v.toDropdown.accountType,frequencyType:v.frequencyDropdown.selectedPrimary,payAmount:v.amount.payAmount,instantTransfer:v.isInstantTransfer(),isExternalTransfer:v.amount.isExternalTransfer,transferDate:v.date,arriveOnDate:v.arriveOnDate,message:v.message,isHeloc:"heloc"===v.from.accountType}},datePickerDone:function(){v.selectedView=r.kTransferViewSelection.kOneTimeTransferView,v.callback=!0,v.backButtonOptions.showBackButton=!1},setTransferFrom:function(e){v.transferFromType=e.accountType,v.resetValues(),v.from=e,v.setDropdownSelected(v.fromDropdown,v.fromDropdownOptions,e),v.setCurrentTransferToList(e),v.setCalendarArriveOnDate(),v.helocMinimumAmount=e.minimumAdvance,v.manageMemoAttributes(),v.resetFrequency(),v.onFrequencySelected(v.frequencyList.data[0]),v.displaySavingsMessage()},onTransferFromSelected:function(e){v.setTransferFrom(e),v.frequencyDropdownOptions.placeholder=v.contentData["ease.core.transfer.form.frequency.onetime"]},onTransferToSelected:function(e){v.to=e,v.setDropdownSelected(v.toDropdown,v.toDropdownOptions,e),v.setFrequencies(e.frequencies),v.showRemainingLimit=e.showRemainingLimit&&!("360"===v.from.accountType)&&!("heloc"===v.from.accountType),v.isTransferToSelected="-1"!==e.referenceId,v.isTransferToSelected&&(v.transferToType=e.accountType),v.dailyLimitRemainingAmount="retail"===v.transferFromType&&"external"===v.transferToType?e.dailyTransferLimit:null,v.monthlyLimitRemainingAmount="retail"===v.transferFromType&&"external"===v.transferToType?e.monthlyTransferLimit:null,v.setCalendarArriveOnDate()},onFrequencySelected:function(e){v.frequencyDropdown.selectedValue=e.displayName,v.frequencyDropdown.selectedPrimary=e.displayName},resetValues:function(){v.errorStatus="",v.resetTransferTo(),v.showRemainingLimit=!1},resetTransferTo:function(){v.isTransferToSelected=!1,v.transferToType="",v.toDropdownOptions.secondaryData="",v.toDropdownOptions.tertiaryData="",v.toDropdownOptions.placeholder=v.contentData["ease.core.transfer.form.transferacct.select.label"],v.toDropdown={accountType:"",isOpen:!1,moneyTransferReferenceId:"",referenceId:"",selectedAccountBalance:"",selectedPrimary:"",selectedSecondary:"",selectedValue:""},v.resetDropdownComponent("transferDropdownTo")},setFrequencies:function(e){v.resetFrequency(),v.isFrequencyTogglecOn()&&e&&e.length&&(_.each(e,function(e){v.frequencyList.data.push({displayName:e.description,displayValue:e.frequency})}),v.isEnableFrequency=!0),v.onFrequencySelected(v.frequencyList.data[0])},isFrequencyTogglecOn:function(){var e=f.getFeatureToggleData();return e&&e[r.features.transferFrequencyFeature]},resetFrequency:function(){v.frequencyList.data?v.frequencyList.data.length=0:v.frequencyList.data=[],v.setDefaultFrequency(),v.isEnableFrequency=!1,v.resetDropdownComponent("frequencyDropdown")},setDefaultFrequency:function(){v.frequencyList.data.push({displayName:v.contentData["ease.core.transfer.form.frequency.onetime"],displayValue:v.contentData["ease.core.transfer.form.frequency.onetime"]})},resetDropdownComponent:function(e){document.dispatchEvent(new CustomEvent("reset-ease-ui-dropdown",{detail:{dropdownID:e,index:-1}}))},dropDownInit:function(){v.fromDropdown.isOpen=!1,v.toDropdown.isOpen=!1,v.frequencyDropdown.isOpen=!1;var e=v.contentData["ease.core.transfer.form.transferacct.select.label"];v.fromDropdownOptions={id:"transferDropdownFrom",placeholder:e,label:v.contentData["ease.core.transfer.form.transferacct.from.label"],sublabel:v.contentData["ease.core.transfer.form.available.label"]},v.toDropdownOptions={id:"transferDropdownTo",placeholder:e,label:v.contentData["ease.core.transfer.form.transferacct.to.label"],sublabel:v.contentData["ease.core.transfer.form.available.label"]},v.frequencyDropdownOptions={id:"frequencyDropdown",placeholder:"Select Frequency",label:v.contentData["ease.core.transfer.form.frequency.label"],sublabel:v.contentData["ease.core.transfer.form.available.label"]},v.resetFrequency()},setDropdownSelected:function(e,t,a){e.isOpen=!1,e.selectedValue=a.displayName,e.selectedPrimary=a.displayName,e.selectedSecondary=a.accountNumber,e.selectedAccountBalance=a.displayBalance,e.accountType=a.accountType,e.moneyReferenceId=a.moneyReferenceId,e.referenceId=a.referenceId||a.externalAccountReferenceId,v.submitted.isSubmitted=!1,t.secondaryData=a.accountNumber,e.selectedAccountBalance?t.tertiaryData=e.selectedAccountBalance:t.tertiaryData=""},setCurrentTransferToList:function(e){v.resetTransferToDropdown();for(var t=v.transferData.length,a=[],r=0;t>r;r++)e.moneyReferenceId===v.transferData[r].moneyTransferAccountReferenceId&&(a=v.transferData[r].eligibleDebitOffsetAccounts);v.transferData.forEach(function(e){if(!/HELOC/i.test(e.accountType)){var t=a.filter(function(t){return t.moneyTransferAccountReferenceId[0]===e.moneyTransferAccountReferenceId})[0];t&&v.transferToList.data.push(n.translateApiResponse(e,t))}}),n.setTransferToList(v.transferToList.data)},resetTransferToDropdown:function(){v.transferToList.data.length=0},displaySavingsMessage:function(){var e=v.from.rawAccountType;e=e?e.toLowerCase():"","money market"===e||-1!==e.indexOf("savings")?v.messageOptions.closeAlert=!0:v.messageOptions.closeAlert=!1},setCalendarArriveOnDate:function(){if(!v.serverTime){var e=n.getServerTime()||new Date;v.serverTime=e instanceof Date?e:new Date(e),v.currentDate=v.serverTime,v.localeDate=v.serverTime,v.todayDate=v.serverTime}var t=new Date(v.currentDate).setHours(0,0,0,0),a=new Date(v.todayDate).setHours(0,0,0,0),o=f.getFeatureToggleData();(v.isTransferInvesting()||"heloc"===v.from.accountType&&o&&!o[r.features.enableHELOCScheduled])&&(v.currentDate=new Date(v.serverTime),v.localeDate=new Date(v.serverTime),v.date=s("date")(new Date(v.serverTime),"MMM dd, yyyy")),"external"!==v.transferFromType&&"external"!==v.transferToType||!i.validateBankDayOffs(new Date(v.currentDate))||(v.currentDate=new Date(v.serverTime),v.localeDate=new Date(v.serverTime),v.date=s("date")(new Date(v.serverTime),"MMM dd, yyyy")),v.amount.isExternalTransfer=/external/.test(v.transferFromType+v.transferToType),v.showArriveOnDate=v.amount.isExternalTransfer&&v.isTransferToSelected,a===t&&v.amount.isExternalTransfer&&(v.currentDate=v.localeDate=v.nextValidDate(v.currentDate)),v.showArriveOnDate?v.setArriveOnDate():(v.arriveOnDate="",v.arriveDate="")}}),t.$watch("memoAttributes.val",function(e,t){b.test(e)||(v.memoAttributes.val=t)}),t.$on("$stateChangeStart",function(){v.close()}),t.$on("error",function(e,t){v.loadingClass=!1,"missingLabel"!==t.msgType&&v.close()}),v.contentData=n.getContentData(),v.dropDownInit(),v.expectedData=d.kTransferFormContentLabel,v.toggleDates(),v.i18nData={today_label:y.getLabel(v.localeVal,T.en.TODAY,T.es.TODAY)},v.initialize(),i.missingContentLabel(v.expectedData,v.contentData),v.transferFromList&&v.transferFromList.length){var A=v.transferFromList[n.getSelectedIdx("transferFrom")];v.transferToList.data=[],v.setTransferFrom(A);var S=o.buildLOB(A.accountType),O={level2:"transfer"};o.trackAnalytics(S,O)}if(v.isTransferEnable=function(){return!v.toDropdown.selectedPrimary||v.amount.payAmount<.01||v.loadingClass||!v.amount.payAmount},u.data.previousStateName===r.stateNames.transferScheduleUnavailable){if(v.date=u.data.date,v.amount.payAmount=u.data.amount,v.memo.memoText=u.data.memo,v.isMemoOpen=u.data.memo?!0:!1,u.data.toReferenceId){var h=n.getSelectedIdx("transferTo",u.data.toReferenceId);v.onTransferToSelected(v.transferToList.data[h])}u.data={}}v.makePayment=function(){v.errorStatus="",v.apiErrorMessage="",v.isTransferToSelected=!1,v.loadingClass=!0,v.transferSubmitted=!0;var e={customerReferenceId:"",fromAccountDetail:{moneyTransferAccountReferenceId:v.fromDropdown.moneyReferenceId},toAccountDetail:{moneyTransferAccountReferenceId:v.toDropdown.moneyReferenceId},transactionAmount:n.formatAmount(v.amount.payAmount).toString(),customerMemo:v.memoAttributes?v.memoAttributes.val:""};v.fromDropdown.selectedAccountBalance||(v.isAvailBalUndefined=!0),v.isInstantTransfer()||(e.oneTimeTransferDate=new Date(v.localeDate).toISOString()),n.transferAmount(e).then(function(e){v.loadingClass=!1,e.accInfo=v.item,u.subCategory&&(e.accInfo.subCategory=u.subCategory),v.setTransferSuccessData(e),e.easeDisplayError?(v.setApiErrorMessage(e.easeDisplayError.displayMessage),v.amount.isInputInValid=!0,v.submitted.isSubmitted=!0,v.amount.errorMessage=!0,v.transferSubmitted=!1,v.isTransferToSelected=!0):v.closeModal(e)},function(){v.isTransferToSelected=!1})}}]),t});