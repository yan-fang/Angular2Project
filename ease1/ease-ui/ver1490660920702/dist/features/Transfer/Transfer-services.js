define(["angular","moment","require"],function(e,n,r){"use strict";var t=e.module("TransferModule");return t.factory("TransferFactory",["EaseConstant","EASEUtilsFactory","$q","$sessionStorage","Restangular","EaseConstantFactory","$filter","easeExceptionsService","appCookie","TransferConstant","NotifyingService",function(n,r,t,a,o,c,s,u,i,f,l){var m=null,T={},d=!1,y=null,p={},v={},g={},A=null,h=0,E=0,C=[],b=[],I={},D=!1,R=null,k={},L="transfer-print",S=e.element(document.body),x="",N=function(e){var r=e.toLowerCase(),t=n.kTransferProductGroup;return r===t.C1Retail?"retail":r===t.C1Direct_360?"360":r===t.C1Direct_360_Ext||r===t.C1Reatil_Ext?"external":r===t.C1HomeEquityCredit?"heloc":r===t.C1Investing?"investing":void 0},U=function(e){var n="";return n="undefined"!=typeof e.accountNickName||"undefined"!=typeof e.accountNickname?e.accountNickName||e.accountNickname:"undefined"!=typeof e.productDescription?e.productDescription:e.accountType},F=function(e){if(e.length>4){var n=s("limitTo")(e,-4);if(-1===n.indexOf("X")&&-1===n.indexOf("."))return"..."+n}return null};return{setMemoText:function(e){x=e},getMemoText:function(){return x||""},formatAmount:function(e){return parseFloat(e.replace(/[^0-9.]/g,""))},getSelectedIdx:function(e,n){if("transferFrom"===e){for(var r=this.getData(e),t=0;t<r.length;t++){var a=r[t];if(a.referenceId===A||a.externalAccountReferenceId===A){h=t;break}}return h}if("transferTo"===e){for(var r=this.getData(e),t=0;t<r.length;t++){var a=r[t];if(a.referenceId===n||a.externalAccountReferenceId===n){E=t;break}}return E}},transferAmount:function(e){var a=t.defer(),s=n.kUmmMakeTransfer;o.setBaseUrl(c.baseUrl());var i=o.all(s);return r.setCustomerActivityHeader("50025"),i.post(e).then(function(e){l.notify("transfers"),a.resolve(e)},function(e){throw a.reject(),u.createEaseException({module:"TransferModule","function":"TransferFactory.transferAmount",message:e.statusText,cause:e})}),a.promise},updateTransfer:function(e){var a=t.defer(),s=n.kUmmUpdateMoneyTransfer;o.setBaseUrl(c.baseUrl());var i=o.all(s);return r.setCustomerActivityHeader("50055"),i.post(e).then(function(e){l.notify("transfers"),a.resolve(e)},function(e){throw a.reject(),u.createEaseException({module:"TransferModule","function":"TransferFactory.submitEditTransfer",message:e.statusText,cause:e})}),a.promise},cancelTransfer:function(e){var a=t.defer(),s=n.kUmmCancelTransfer,i={moneyTransferReferenceId:e};o.setBaseUrl(c.baseUrl());var f=o.all(s);return r.setCustomerActivityHeader("50056"),f.post(i).then(function(e){a.resolve(e)},function(e){throw a.reject(),u.createEaseException({module:"TransferModule","function":"TransferFactory.cancelTransfer",message:e.statusText,cause:e})}),a.promise},isDataChanged:function(){return d},getTransferFrom:function(){return p},getTransferTo:function(){return v},setTransferData:function(e){null!==m&&(d=!d,p=null,v=null),m=e},setEditTransferData:function(e){e.fromAccount.accountType=N(e.fromAccount.groupCode),e.toAccount.accountType=N(e.toAccount.groupCode),e.fromAccount.displayName=U(e.fromAccount),e.toAccount.displayName=U(e.toAccount),e.fromAccount.accountNumber=F(e.fromAccount.accountNumber),e.toAccount.accountNumber=F(e.toAccount.accountNumber),I=e},setContentData:function(e){k=e&&e[f.kCoreTransfer]?e[f.kCoreTransfer]:{}},getContentData:function(){return k},getErrorResponse:function(){return g},setErrorResponse:function(e){g=e},getTransferData:function(){return m},getTransferFromList:function(){return C},getTransferToList:function(){return b},getEditTransferData:function(){return I},getData:function(e){return"transferFrom"===e?C:"transferTo"===e?b:void 0},setSuccessData:function(e){y=e},getSuccessData:function(){return y},setAccItem:function(e){A=e.accountRefId,T=e},getAccItem:function(){return T},getLob:function(e){for(var r in n.lineOfBusiness)if(n.lineOfBusiness[r]===e)return r},setServerTime:function(e){R=e},getServerTime:function(){return R},getTransferInfo:function(){var e=t.defer(),a=this,s=n.kUmmTransferGetAccounts,i={customerReferenceId:""};return o.setBaseUrl(c.baseUrl()),r.setCustomerActivityHeader("50024"),o.all(s).post(i).then(function(n){D=!0,a.setTransferFromList(n.entries),a.setTransferData(n.entries),a.setErrorResponse(n.errorResponse),a.setServerTime(n.easternTime),e.resolve(n)},function(n){throw e.reject(n),u.createEaseException({module:"TransferModule","function":"TransferFactory.getTransferInfo",message:n.statusText,cause:n})}),e.promise},getEditTransferInfo:function(e,a){var s=t.defer(),i=this,f=n.kUmmTransferGetDetails+"/"+encodeURIComponent(a),l={customerReferenceId:""};return o.setBaseUrl(c.baseUrl()),r.setCustomerActivityHeader("50055"),o.all(f).post(l).then(function(e){i.setServerTime(e.easternTime),s.resolve(e)},function(e){throw s.reject(e),u.createEaseException({module:"TransferModule","function":"TransferFactory.getEditTransferInfo",message:e.statusText,cause:e})}),s.promise},setTransferFromList:function(e){var n=this,r=e.length;D&&(C=[]);for(var t=0;r>t;t++)e[t].eligibleDebitOffsetAccounts.length>0&&C.push(n.translateApiResponse(e[t]))},setCurrentTransferToList:function(e){var n=this,r=m.length;D&&(b=[]);for(var t=[],a=0;r>a;a++)e.moneyReferenceId===m[a].moneyTransferAccountReferenceId&&(t=m[a].eligibleDebitOffsetAccounts);for(var o=t.length,c=0;o>c;c++)for(var s=0;r>s;s++)"HELOC"!==m[s].accountType&&t[c].moneyTransferAccountReferenceId[0]===m[s].moneyTransferAccountReferenceId&&b.push(n.translateApiResponse(m[s],t[c]))},setTransferToList:function(e){b=e},translateApiResponse:function(e,n){var r={};return r.displayName=U(e),r.accountNumber=F(e.displayAccountNumber),r.displayBalance=s("currency")(e.availableBalance),r.accountType=N(e.productGroup),r.rawAccountType=e.accountType,r.category=e.productDescription,r.showRemainingLimit="external"===r.accountType&&!("360"===r.accountType),r.moneyReferenceId=e.moneyTransferAccountReferenceId,r.referenceId=e.accountReferenceId,r.externalAccountReferenceId=e.externalAccountReferenceId,r.message=e.message,r.minimumAdvance=e.minimumAdvance>0?e.minimumAdvance:"",r.frequencies=n&&n.supportedPlans?n.supportedPlans.recurringFrequencies:null,n&&"currentDayTransferAvailableAmount"in n&&(r.dailyTransferLimit=n.currentDayTransferAvailableAmount),n&&"currentMonthTransferAvailableAmount"in n&&(r.monthlyTransferLimit=n.currentMonthTransferAvailableAmount),r},setPrintClass:function(){S.addClass(L)},removePrintClass:function(){S.removeClass(L)},getPageType:function(e){return"accountSummary"===e?"account summary":"account details"}}}]),t.factory("TransferAnalytics",["pubsubService","EASEUtilsFactory","summaryService","transferState","$stateParams","TransferConstant",function(e,n,r,t,a,o){return{trackAnalytics:function(n,c,s){function u(e){return e||""}function i(e){return"one time"===e.frequency?e.isInstant?o.kTransferTypes.oneTimeInstant:o.kTransferTypes.oneTimeScheduled:"weekly"===e.frequency?o.kTransferTypes.recurringWeekly:"bi-weekly"===e.frequency?o.kTransferTypes.recurringBiWeekly:"twice monthly"===e.frequency?o.kTransferTypes.recurringTwiceAMonth:"monthly"===e.frequency?o.kTransferTypes.recurringMonthly:"quarterly"===e.frequency?o.kTransferTypes.recurringQuarterly:void 0}var f=t.getCurrentLOB(),l="";"accountSummary"===f?l=r.getLobArray().join(" | "):a.accountDetails&&(l=a.accountDetails.subCategory);var m=n?n:l,T={level1:"ease",level2:u(c.level2),level3:u(c.level3),level4:u(c.level4),level5:u(c.level5),country:"us",language:"english",system:"ease_web"},d={taxonomy:T,lob:m};s&&(d.selfservice={type:i(s)}),e.pubsubTrackAnalytics(d)},buildLOB:function(e,n){function r(e){return"heloc"===e?"home loans":e||""}return e=r(e),n?(n=r(n),e+" | "+n):e},trackAnalyticsByName:function(n){e.pubsubTrackAnalytics({name:n})}}}]),t.value("LabelEnums",{en:{SEND:"SEND",ARRIVE:"ARRIVE",TODAY:"TODAY"},es:{SEND:"ENVIAR",ARRIVE:"LLEGAR",TODAY:"HOY"}}),t.service("LocaleService",function(){this.localeConstants=function(){var e={"EN-US":{momentLocaleId:"en"},"ES-US":{momentLocaleId:"es"},"EN-CA":{momentLocaleId:"en-ca"},"FR-CA":{momentLocaleId:"fr-ca"}};return e}}),t.factory("CalendarService",["$q","$injector","EaseConstant","LocaleService",function(t,a,o,c){var s={};return s.getDates=function(){function n(n){var r=n instanceof Date?n:new Date(n),t=e.copy(r);return t.setFullYear(t.getFullYear()+1),{minDate:r,maxDate:t,serverTime:r}}var r=a.get("TransferFactory"),o=r.getServerTime()||new Date,c=n(o);return t.when(c)},s.getLabel=function(e,n,r){var t="";switch(e){case o.kEnglishLocale:t=n;break;case o.kSpanishLocale:t=r;break;default:t=n}return t},s.getLocale=function(e){function t(){n.locale(s)}var a="en",o=e?e.toUpperCase():a,s=c.localeConstants()[o].momentLocaleId;"en"===s?n.locale(a):r(["moment/locale/"+s],t)},s}]),t});