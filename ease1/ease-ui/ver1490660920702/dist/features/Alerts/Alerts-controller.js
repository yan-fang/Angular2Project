define(["angular"],function(e){function t(t,r,a,n,i,s,o,l,c,u,d,y,p){function m(e){return i.trimAccountNumber(e)}function f(){u.pubsubTrackAnalytics({taxonomy:{level1:"ease",level2:"customer profile preferences",level3:"alerts",level4:"edit alerts",level5:"",country:"us",language:"english",system:"ease_web"},lob:"coaf"})}function b(){u.pubsubTrackAnalytics({taxonomy:{level1:"ease",level2:"customer profile preferences",level3:"alerts",level4:"edit alerts",level5:"",country:"us",language:"english",system:"ease_web"},lob:"card"})}function h(e,t){l.showModal({templateUrl:c.get("Alerts","","editModal"),controller:"editAlertsController",inputs:{alertsContentData:I,coafAccount:e,alertsArray:t}}).then(function(e){e.close.then(function(){S()})})}function A(e){C.disablePencil||(w?(C.disablePencil=!0,i.getAlerts(e,"card").then(function(t){C.disablePencil=!1,N(t,e)},function(){C.disablePencil=!1})):T())}function g(e,t,r){l.showModal({templateUrl:c.get("Alerts","","editCardModal"),controller:"editCardAlertsController",inputs:{alertsContentData:I,cardAccount:e,cardAlertsArray:t,securityAlertsArray:r,viewSecurityAlerts:E,viewOsrAlerts:k}}).then(function(e){e.close.then(function(){S()})})}function v(e){C.disablePencil||(P?(C.disablePencil=!0,i.getAlerts(e,"coaf").then(function(t){C.disablePencil=!1,f(),h(e,t)},function(){C.disablePencil=!1})):T())}function S(){u.pubsubTrackAnalytics({taxonomy:{level1:"ease",level2:"customer profile preferences",level3:"alerts",level4:"",level5:"",country:"us",language:"english",system:"ease_web"}})}function T(){s.displayErrorHadler(n.defaultErrorMessage.msgHeader,t.common_snag_en_US["core.common.snag.featureoff.short.label"])}var C=this,I=t[o.kCoreAlerts+o.kLanguagePreferences],P=r[n.features.enableEditAlerts],w=r[n.features.enableEditCardAlerts],E=r[n.features.enableDisplaySecurityAlerts]||!1,k=r[n.features.enableDisplayOsrAlerts],D=function(){s.displayErrorHadler(n.defaultErrorMessage.msgHeader,t.common_snag_en_US["core.common.snag.featureoff.short.label"]),a.go("accountSummary")};if(S(),r[n.features.enableDisplayAlerts]){var L=p.getLobArray(),F=d.includes(L,"card"),M=d.includes(L,"coaf"),O={};r[n.features.enableDisplayCoafAlerts]&&M&&(O.AL="coafArray"),r[n.features.enableDisplayCardAlerts]&&F&&(O.CC="cardArray");var $=Object.getOwnPropertyNames(O);$.length?$.forEach(function(e){i.getAccountsWithAlerts(e).then(function(t){C[O[e]]=t})}):D()}else D();var N=function(e,t){var r=e.easeDisplayError||{};if(!d.isEmpty(r)&&r.displayMessage)"1"===r.severity&&i.showSnag(r);else{var a=[],n=[];e.entries&&e.entries.alertSubscription&&(a=e.entries.alertSubscription),e.entries&&e.entries.securityAlertSubscription&&(n=e.entries.securityAlertSubscription),b(),g(t,a,n)}};e.extend(C,{alertsContentData:I,alertsProfileLabels:t[o.kCoreGlobalDropdown+o.kLanguagePreferences],trimAccountNumber:m,openAlertsModal:v,openCardAlertsModal:A,isShowAlert:y.isAlertsClosed})}function r(t,r,a,n,i,s,o,l){function c(){return t.trimAccountNumber(i.accountNumberTLNPI)}function u(e){a.loadingCSS="loading",s.pubsubTrackAnalytics({name:"update:button"}),t.updateAlertSubscriptions(e)["finally"](function(){a.close()})}function d(e){return e.replace(/ /g,"").toLowerCase()}var y=l.$on("$stateChangeStart",r);a.$on("$destroy",function(){y()}),e.extend(a,{close:r,content:n,alertAccount:i,trimmedAccountNumber:c,submitAlerts:u,alertsArray:o,loadingCSS:"",generateIdentifier:d})}function a(t,r,a,n,i,s,o,l,c,u,d,y){function p(){var e="-- --"===o.displayName?o.originalProductName:o.displayName;return e+="..."+t.trimAccountNumber(o.accountNumberTLNPI)}function m(){h&&i.pubsubTrackAnalytics({name:"update:button"}),r()}function f(){var e=s?s[0].eligibleContactPoints.contactPointSummary:[],t=u.filter(e,function(e){return"PHN"===e.destinationType&&("ACT"===e.contactPointStatus||"UAS"===e.contactPointStatus)});return t&&1===t.length?(a.phone=t[0],!0):!1}function b(e){return/onlstr/i.test(e.alertTypeCode)?y:!0}var h=!1;a.phone={};var A=t.showSendToPrimEmailText(s),g=a.$on("updateAlerts",function(e,t){h=!0,a.disableUpdate=t,a.close=a.disableUpdate?function(){}:r,e.stopPropagation()}),v=d.$on("$stateChangeStart",r);a.$on("$destroy",function(){g(),v()}),e.extend(a,{close:r,content:n,cardAlertAccount:o,cardAlertsArray:s,securityAlertsArray:l,getCardAccName:p,loadingCSS:"",disableUpdate:!1,viewSecurityAlerts:c,closeWithPubsub:m,smsEnabled:f(),displayAlert:b,showSendToPrimEmailText:A})}function n(t,r,a,n,s,o){function l(e){f.errorStatus="error",f.errorMsg=e,S=!0}function c(){if("Daily"===f.selectedItem)f.alert.alertFrequency.dailyFrequency.dailyIndicator=!0;else if("Weekly"===f.selectedItem){var e=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];f.alert.alertFrequency.weeklyFrequency.dayOfTheWeek=e.indexOf(f.nested.selectedItem)+1}else"Monthly"===f.selectedItem?f.alert.alertFrequency.monthlyFrequency.dayOfTheMonth=f.nested.selectedItem:f.alert.alertFrequency.alertDaysInAdvance.alertDaysInAdvanceValue=f.selectedItem}function u(){1===f.options.length&&"alertDaysInAdvance"===f.options[0].type?f.alert.alertFrequency.alertDaysInAdvance={usableIndicator:!0}:(f.alert.alertFrequency.dailyFrequency={usableIndicator:!0},f.alert.alertFrequency.weeklyFrequency={usableIndicator:!0},f.alert.alertFrequency.monthlyFrequency={usableIndicator:!0})}function d(){a(function(){f.alert=e.copy(m.alert),f.inputValue=m.inputValue,h(m.selectedItem),b(m.nested.selectedItem),f.nested.items=m.nested.items,f.isNestedComponent=m.isNestedComponent,f.emailList=m.emailList},0)}function y(e){if(f.isOsr)return!0;if(f.alert.sendToContactPoints){var r=t.find(f.alert.sendToContactPoints.contactPointSummary,function(t){return t.destinationType===e});return r?!0:!1}return!1}function p(){return/ONLSTR/i.test(f.alert.alertTypeCode)?(f.alertTitle=f.content["ease.core.alertsprefs.cc.osralert.title"],!0):(f.alertTitle=f.alert.alertTypeDescription,!1)}var m,f=this,b=function(e){f.nested.tempSelectedItem=e,f.nested.selectedItem=e},h=function(e){f.tempSelectedItem=e,f.selectedItem=e},A=/Email/i;f.selectedFrequency={},f.nested={isOpen:!1,items:[],selected:function(e){e&&f.nested.tempSelectedItem!==e&&(b(e),f.alert.subscribedIndicator&&f.updateAlerts())},data:{id:"alert_nested_id"+f.index,placeholder:"",label:f.content["ease.core.alertsprefs.summarysendday.aria"]}},h(""),f.isNestedComponent=!1,f.populatedNested=function(e){f.isNestedComponent=!0,"Weekly"===e?f.nested.items=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"]:"Monthly"===e&&(f.nested.items=t.range(1,29)),b(f.nested.items[0])},f.options=function(){var e=[],t=f.alert.alertFrequency;return Object.getOwnPropertyNames(t).forEach(function(r){if(t[r].usableIndicator){var a=new i(t[r],r);if(e.push(a),a.value)if("alertDaysInAdvanceValue"===a.key)h(a.value);else if(h(a.option),"Weekly"===a.option){f.populatedNested(a.option);var n=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];b(n[a.value-1])}else"Monthly"===a.option&&(f.populatedNested(a.option),b(a.value))}}),e}(),f.isAlertTrigger=f.alert.alertTrigger.usableIndicator||!1,f.inputValue=f.alert.alertTrigger.criteriaValue&&f.alert.alertTrigger.criteriaValue>=0?f.alert.alertTrigger.criteriaValue:void 0,f.isAlertFrequency=!t.isEmpty(f.options),f.isAccountAlert="A"===f.alert.alertType,f.isSecurityAlert="S"===f.alert.alertType,f.disableUpdate=!1,f.ddItems=[],f.emailCheckboxAriaLabel=f.alert.alertTypeDescription+" "+f.content["ease.core.profileprefs.alerts.editmodal.email.label"],f.smsCheckboxAriaLabel=f.alert.alertTypeDescription+" "+f.content["ease.core.profileprefs.alerts.editmodal.sms.label"];var g=function(){f.showEditLink=f.subscribedIndicatorEmail&&f.emailList.length>1&&!f.drawerOpened};f.drawerOpened=!1,f.showMultiEmails=function(){return!f.isOsr&&f.showEditLink},f.isShowDrawer=function(){return!f.isOsr&&f.emailList.length>1};var v;f.onInit=function(){f.isAlertFrequency&&(f.isOpen=!1,1===f.options.length&&"alertDaysInAdvance"===f.options[0].type?f.items=[5,7,10]:f.items=f.options.map(function(e){return e.option}),f.alert.subscribedIndicator||(h(f.items[0]),f.isNestedComponent=!1),f.data={id:"alert_id"+f.index,placeholder:"",label:f.genLabel()}),a(function(){m=e.copy(f)},0),f.isOsr=p(),f.subscribedIndicatorPhone=f.alert.subscribedIndicator?y("PHN"):!1,f.subscribedIndicatorEmail=f.alert.subscribedIndicator?y("EML"):!1,f.alert.sendToContactPoints||(f.alert.sendToContactPoints={contactPointSummary:[]}),f.alert.eligibleContactPoints||(f.alert.eligibleContactPoints={contactPointSummary:[]}),f.eligibleEmails=t.filter(f.alert.eligibleContactPoints.contactPointSummary,{destinationType:"EML"}),f.emailList=e.copy(f.eligibleEmails),f.emailList.forEach(function(e){f.alert.sendToContactPoints.contactPointSummary.forEach(function(t){e.alertDestination===t.alertDestination&&(e.checked=!0)})}),a(function(){m=e.copy(f)},0),v=n.$on("showEditLinkEvt",function(e,t){t.index!==f.index&&f.drawerOpened&&(f.drawerOpened=!1,o[0].dispatchEvent(new CustomEvent("toggle-drawer",{detail:{actionType:"close",drawerId:"drawer"+f.index},bubbles:!0,cancelable:!0}))),g()}),g()},f.selected=function(e){e&&f.tempSelectedItem!==e&&(h(e),b(""),"Weekly"===e||"Monthly"===e?f.populatedNested(e):f.isNestedComponent=!1,f.alert.subscribedIndicator&&f.updateAlerts())},f.genIdForInput=function(){return"inputAlert_"+f.index},f.genLabel=function(){switch(f.alert.alertTypeCode){case"TRXABX":return f.content["ease.core.alertsprefs.hightrans.aria"];case"BALABX":return f.content["ease.core.alertsprefs.highbal.aria"];case"AVCRLX":return f.content["ease.core.alertsprefs.closetolimit.aria"];case"PAYDUE":return f.content["ease.core.alertsprefs.paymentdue.aria"];case"BALSUM":return f.content["ease.core.alertsprefs.summaryfreq.aria"]}};var S=!1;f.resetErrorStatus=function(e){n.$evalAsync(function(){f.errorStatus="",f.errorMsg="",e||f.alert.subscribedIndicator&&!f.inputValue&&(f.inputValue=f.alert.alertTrigger.criteriaValue&&f.alert.alertTrigger.criteriaValue>0?f.alert.alertTrigger.criteriaValue:void 0)})},f.checkBeforeResettingErrorStatus=function(){S?S=!1:f.resetErrorStatus()};var T=function(a){var i=a.easeDisplayError||{};!t.isEmpty(i)&&i.displayMessage?("1"===i.severity?r.showSnag(i):"2"===i.severity&&l(i.displayMessage),d()):m=e.copy(f),n.disableUpdate=!1,n.$emit("updateAlerts",!1)},C=function(e){f.emailList.forEach(function(t){t.checked=e})};f.emailCheckBoxClickHandler=function(e,t){f.subscribedIndicatorEmail=f.getSendToEmailList().length>0?!0:!1,f.updateAlerts(t),e.stopPropagation()},f.checkBoxHandler=function(e,t){return f.disableUpdate&&e.preventDefault(),f.isAlertTrigger&&f["subscribedIndicator"+t]&&!f.inputValue?(l(f.content["ease.core.profileprefs.alerts.editmodal.missingvalue.error"]),void(f["subscribedIndicator"+t]=!1)):(A.test(t)&&(f.openDrawer(f.index,!f["subscribedIndicator"+t]),C(f["subscribedIndicator"+t])),void f.updateAlerts(t))};var I=function(){return t.filter(f.alert.sendToContactPoints.contactPointSummary,function(e){return!/EML/i.test(e.destinationType)})};f.updateAlerts=function(e){e&&!f.isOsr?f["subscribedIndicator"+e]?(f.alert.subscribedIndicator=!0,A.test(e)?(f.alert.sendToContactPoints.contactPointSummary=I(),f.alert.sendToContactPoints.contactPointSummary=f.alert.sendToContactPoints.contactPointSummary.concat(f.getSendToEmailList())):f.alert.sendToContactPoints.contactPointSummary.push(f["get"+e])):(A.test(e)?f.alert.sendToContactPoints.contactPointSummary=I():f.alert.sendToContactPoints.contactPointSummary=t.filter(f.alert.sendToContactPoints.contactPointSummary,function(t){return t.alertDestination!==f["get"+e].alertDestination}),f.alert.subscribedIndicator=f.alert.sendToContactPoints.contactPointSummary.length>0):f.isOsr&&(f.alert.subscribedIndicator=f.subscribedIndicatorEmail),f.isAlertFrequency&&(u(),(e&&f["subscribedIndicator"+e]||f.alert.subscribedIndicator)&&(c(),n.disableUpdate=!0)),n.$emit("updateAlerts",!0),n.disableUpdate=!0,r.postAlerts(f.account,"card",f.alert).then(T,function(){n.disableUpdate=!1,d()})},f.openDrawer=function(e,t){s.$broadcast("showEditLinkEvt",{index:e}),t||(f.drawerOpened=!0,o[0].dispatchEvent(new CustomEvent("toggle-drawer",{detail:{actionType:"open",drawerId:"drawer"+e},bubbles:!0,cancelable:!0})),g())},f.getSendToEmailList=function(){return t.filter(f.emailList,{checked:!0})},f.validateInput=function(){f.errorStatus="",f.errorMsg="",f.alert.subscribedIndicator?f.inputValue?f.alert.alertTrigger.criteriaValue!==f.inputValue&&(f.alert.alertTrigger.criteriaValue=f.inputValue,f.updateAlerts()):a(function(){l(f.content["ease.core.profileprefs.alerts.editmodal.missingvalue.error"])},0):f.alert.alertTrigger.criteriaValue=f.inputValue},n.$on("$destroy",function(){v()}),f.onInit()}function i(e,t){this.type=t,this.value=void 0,this.key=void 0,this.init=function(){switch(t){case"alertDaysInAdvance":this.key="alertDaysInAdvanceValue",this.value=e.hasOwnProperty(this.key)?e[this.key]:void 0;break;case"dailyFrequency":this.key="dailyIndicator",this.option="Daily",this.value=e.hasOwnProperty(this.key)?e[this.key]:void 0;break;case"weeklyFrequency":this.key="dayOfTheWeek",this.option="Weekly",this.value=e.hasOwnProperty(this.key)?e[this.key]:void 0;break;case"monthlyFrequency":this.key="dayOfTheMonth",this.option="Monthly",this.value=e.hasOwnProperty(this.key)?e[this.key]:void 0}},this.init()}e.module("AlertsModule").controller("alertsController",t).controller("editAlertsController",r).controller("editCardAlertsController",a).controller("alertRowController",n),t.$inject=["contentData","featureToggleData","$state","EaseConstant","alertsFactory","easeExceptionsService","ContentConstant","easeUIModalService","easeTemplates","pubsubService","_","EASEUtilsFactory","summaryService"],r.$inject=["alertsFactory","close","$scope","alertsContentData","coafAccount","pubsubService","alertsArray","$rootScope"],a.$inject=["alertsFactory","close","$scope","alertsContentData","pubsubService","cardAlertsArray","cardAccount","securityAlertsArray","viewSecurityAlerts","_","$rootScope","viewOsrAlerts"],n.$inject=["_","alertsFactory","$timeout","$scope","$rootScope","$element"]});